# ë°ì´í„°ë² ì´ìŠ¤

```bash
docker run --name postgres16 \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgres \
  -e POSTGRES_DB=postgres \
  -p 5555:5432 \
  -d postgres:16.3
```

## 1. TypeORM ê¸°ë³¸ê¸°

TypeORMì€ TypeScriptì™€ JavaScript í™˜ê²½ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ORM(Object-Relational Mapping) ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤.

ORMì€ ë°ì´í„°ë² ì´ìŠ¤ì˜ í…Œì´ë¸”ê³¼ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ í´ë˜ìŠ¤ë¥¼ 1:1ë¡œ ë§¤í•‘ì‹œì¼œì£¼ì–´, SQL ì—†ì´ë„ DB ì‘ì—…ì„ ê°ì²´ ì§€í–¥ì ìœ¼ë¡œ í•  ìˆ˜ ìˆê²Œ ë„ì™€ì¤ë‹ˆë‹¤.

 - OOPë¥¼ ì‚¬ìš©í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì„ í´ë˜ìŠ¤ë¡œ ê´€ë¦¬
 - ë‹¤ì–‘í•œ ë°ì´í„°ë² ì´ìŠ¤ ì§€ì›
 - Active Recordì™€ Data Mapper íŒ¨í„´ì„ ëª¨ë‘ ì§€ì›
 - ìì²´ì ìœ¼ë¡œ Migration ê¸°ëŠ¥ì„ ì§€ì›í•˜ë©° ì ì§„ì ì¸ ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ë³€ê²½ê³¼ ë²„ì €ë‹ ëª¨ë‘ ì§€ì›
 - Eager & Lazy ë¡œë”©ì„ ëª¨ë‘ ì§€ì›í•˜ê¸° ë•Œë¬¸ì— ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ì§€ ì»¨íŠ¸ë¡¤ ê°€ëŠ¥
```bash
npm install typeorm reflect-metadata
npm install mysql2 # ë˜ëŠ” pg, sqlite3 ë“± ì›í•˜ëŠ” DB í´ë¼ì´ì–¸íŠ¸

# NestJS ì‚¬ìš©ì‹œ
npm install @nestjs/typeorm typeorm reflect-metadata
```

### 1-1. ê¸°ë³¸ ì‚¬ìš©ë²•

 - `Entity`
    - @Column
        - type: ì»¬ëŸ¼ íƒ€ì…
        - name: ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë  ì»¬ëŸ¼ ì´ë¦„
        - nullable: Null í—ˆìš© ì—¬ë¶€(ê¸°ë³¸ê°’ false)
        - update: ì—…ë°ì´íŠ¸ ê°€ëŠ¥ ì—¬ë¶€(ê¸°ë³¸ê°’ true)
        - select: ì¿¼ë¦¬ ì‹¤í–‰ì‹œ í”„ë¡œí¼í‹°ë¥¼ ê°€ì ¸ì˜¬ì§€ ê²°ì •
        - default: ì»¬ëŸ¼ ê¸°ë³¸ê°’
        - unique: ìœ ë‹ˆí¬ ì œì•½ì¡°ê±´ ì ìš© ì—¬ë¶€
        - comment: ì»¬ëŸ¼ ì½”ë©˜íŠ¸
        - enum: ì»¬ëŸ¼ì— ì…ë ¥ ê°€ëŠ¥í•œ ê°’ì„ enumìœ¼ë¡œ ë‚˜ì—´
        - array: ì»¬ëŸ¼ array íƒ€ì…ìœ¼ë¡œ ìƒì„±
    - íŠ¹ìˆ˜ Column
        - @CreateDateColum: ìë™ìœ¼ë¡œ ROW ìƒì„±ì‹œ ìƒì„±ì¼ì‹œ ì €ì¥
        - @UpdateDateColumn: ìë™ìœ¼ë¡œ ROW ì—…ë°ì´íŠ¸ì‹œ ìˆ˜ì •ì¼ì‹œ ì €ì¥
        - @DeleteDateColumn: ìë™ìœ¼ë¡œ ROWì˜ SOFT DELETE ë‚ ì§œ ì‹œê°„ ì €ì¥
        - @VersionColumn: ìë™ìœ¼ë¡œ ROWê°€ ì—…ë°ì´íŠ¸ë  ë•Œë§ˆë‹¤ 1ì”© ì¦ê°€
```typescript
// user.entity.ts
import { Entity, PrimaryGeneratedColumn, Column } from 'typeorm';

@Entity()
export class User {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;

  @Column({ unique: true })
  email: string;

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;

  @DeleteDateColumn()
  deletedAt: Date;

  @VersionColumn()
  version: number;
}
```

 - `DaataSource ì„¤ì •`
    - synchronize: trueëŠ” Entity í´ë˜ìŠ¤ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìë™ìœ¼ë¡œ í…Œì´ë¸”ì„ ìƒì„±/ê°±ì‹ 
```typescript
// data-source.ts
import { DataSource } from 'typeorm';
import { User } from './user.entity';

export const AppDataSource = new DataSource({
  type: 'mysql', // or 'postgres'
  host: 'localhost',
  port: 3306,
  username: 'root',
  password: '',
  database: 'test',
  entities: [User],
  synchronize: true, // ê°œë°œ ì¤‘ì—ëŠ” true, ìš´ì˜ í™˜ê²½ì—ì„œëŠ” false
});
```

 - `ê¸°ë³¸ CRUD`
```typescript
const userRepo = AppDataSource.getRepository(User);

// CREATE
const user = userRepo.create({ name: 'kim', email: 'kim@example.com' });
await userRepo.save(user);

// READ
const allUsers = await userRepo.find();
const oneUser = await userRepo.findOneBy({ id: 1 });

// UPDATE
user.name = 'Lee';
await userRepo.save(user);

// DELETE
await userRepo.delete(1);
```

 - `NestJS ì˜ˆì‹œ`
```typescript
// app.module.ts
import { TypeOrmModule } from '@nestjs/typeorm';

@Module({
  imports: [
    TypeOrmModule.forRoot({
      type: 'mysql',
      host: 'localhost',
      username: 'root',
      database: 'test',
      entities: [User],
      synchronize: true,
    }),
    TypeOrmModule.forFeature([User]), // ë ˆí¬ì§€í† ë¦¬ ì£¼ì…ìš©
  ],
})
export class AppModule {}

// user.service.ts
@Injectable()
export class UserService {
  constructor(
    @InjectRepository(User)
    private readonly userRepo: Repository<User>,
  ) {}

  async getAllUsers() {
    return this.userRepo.find();
  }
}
```

### 1-2. NextJS TypeORM ì‚¬ìš© ì˜ˆì‹œ

 - `ëª¨ë“ˆ ì„¤ì¹˜`
```bash
pnpm i @nestjs/config joi @nestjs/typeorm typeorm pg
```

 - `DB ì„¤ì •`
```typescript
import { Module } from '@nestjs/common';
import { MovieModule } from './movie/movie.module';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ConfigModule, ConfigService } from '@nestjs/config';
import * as Joi from 'joi';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      validationSchema: Joi.object({
        ENV: Joi.string().valid('dev', 'prod', 'test').required(),
        DB_TYPE: Joi.string().valid('postgres').required(),
        DB_HOST: Joi.string().required(),
        DB_PORT: Joi.number().required(),
        DB_USERNAME: Joi.string().required(),
        DB_PASSWORD: Joi.string().required(),
        DB_DATABASE: Joi.string().required(),
      }),
    }),
    TypeOrmModule.forRootAsync({
      imports: [ConfigModule],
      inject: [ConfigService],
      useFactory: (config: ConfigService) => ({
        type: config.get<'postgres'>('DB_TYPE'), // ğŸ‘ˆ ì—¬ê¸°ì„œ ì œë„¤ë¦­ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ
        host: config.get<string>('DB_HOST'),
        port: config.get<number>('DB_PORT'),
        username: config.get<string>('DB_USERNAME'),
        password: config.get<string>('DB_PASSWORD'),
        database: config.get<string>('DB_DATABASE'),
        entities: [],
        synchronize: true,
      }),
    }),
    /*
    TypeOrmModule.forRoot({
      type: process.env.DB_TYPE,
      host: process.env.DB_HOST,
      port: process.env.DB_PORT,
      username: process.env.DB_USERNAME,
      password: process.env.DB_PASSWORD,
      database: process.env.DB_DATABASE,
      entities: [],
      synchronize: true,
    }),
    */
    MovieModule,
  ],
})
export class AppModule {}
```



## 2. QueryBuilder

## 3. Transaction

## 4. ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
