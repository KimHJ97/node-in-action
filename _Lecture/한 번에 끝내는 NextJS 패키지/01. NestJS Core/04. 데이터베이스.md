# ë°ì´í„°ë² ì´ìŠ¤

```bash
docker run --name postgres16 \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgres \
  -e POSTGRES_DB=postgres \
  -p 5555:5432 \
  -d postgres:16.3
```

## 1. TypeORM ê¸°ë³¸ê¸°

TypeORMì€ TypeScriptì™€ JavaScript í™˜ê²½ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ORM(Object-Relational Mapping) ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤.

ORMì€ ë°ì´í„°ë² ì´ìŠ¤ì˜ í…Œì´ë¸”ê³¼ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ í´ë˜ìŠ¤ë¥¼ 1:1ë¡œ ë§¤í•‘ì‹œì¼œì£¼ì–´, SQL ì—†ì´ë„ DB ì‘ì—…ì„ ê°ì²´ ì§€í–¥ì ìœ¼ë¡œ í•  ìˆ˜ ìˆê²Œ ë„ì™€ì¤ë‹ˆë‹¤.

- OOPë¥¼ ì‚¬ìš©í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì„ í´ë˜ìŠ¤ë¡œ ê´€ë¦¬
- ë‹¤ì–‘í•œ ë°ì´í„°ë² ì´ìŠ¤ ì§€ì›
- Active Recordì™€ Data Mapper íŒ¨í„´ì„ ëª¨ë‘ ì§€ì›
- ìì²´ì ìœ¼ë¡œ Migration ê¸°ëŠ¥ì„ ì§€ì›í•˜ë©° ì ì§„ì ì¸ ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ë³€ê²½ê³¼ ë²„ì €ë‹ ëª¨ë‘ ì§€ì›
- Eager & Lazy ë¡œë”©ì„ ëª¨ë‘ ì§€ì›í•˜ê¸° ë•Œë¬¸ì— ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ì§€ ì»¨íŠ¸ë¡¤ ê°€ëŠ¥

```bash
npm install typeorm reflect-metadata
npm install mysql2 # ë˜ëŠ” pg, sqlite3 ë“± ì›í•˜ëŠ” DB í´ë¼ì´ì–¸íŠ¸

# NestJS ì‚¬ìš©ì‹œ
npm install @nestjs/typeorm typeorm reflect-metadata
```

### 1-1. ê¸°ë³¸ ì‚¬ìš©ë²•

- `Entity`
  - @Column
    - type: ì»¬ëŸ¼ íƒ€ì…
    - name: ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë  ì»¬ëŸ¼ ì´ë¦„
    - nullable: Null í—ˆìš© ì—¬ë¶€(ê¸°ë³¸ê°’ false)
    - update: ì—…ë°ì´íŠ¸ ê°€ëŠ¥ ì—¬ë¶€(ê¸°ë³¸ê°’ true)
    - select: ì¿¼ë¦¬ ì‹¤í–‰ì‹œ í”„ë¡œí¼í‹°ë¥¼ ê°€ì ¸ì˜¬ì§€ ê²°ì •
    - default: ì»¬ëŸ¼ ê¸°ë³¸ê°’
    - unique: ìœ ë‹ˆí¬ ì œì•½ì¡°ê±´ ì ìš© ì—¬ë¶€
    - comment: ì»¬ëŸ¼ ì½”ë©˜íŠ¸
    - enum: ì»¬ëŸ¼ì— ì…ë ¥ ê°€ëŠ¥í•œ ê°’ì„ enumìœ¼ë¡œ ë‚˜ì—´
    - array: ì»¬ëŸ¼ array íƒ€ì…ìœ¼ë¡œ ìƒì„±
  - íŠ¹ìˆ˜ Column
    - @CreateDateColum: ìë™ìœ¼ë¡œ ROW ìƒì„±ì‹œ ìƒì„±ì¼ì‹œ ì €ì¥
    - @UpdateDateColumn: ìë™ìœ¼ë¡œ ROW ì—…ë°ì´íŠ¸ì‹œ ìˆ˜ì •ì¼ì‹œ ì €ì¥
    - @DeleteDateColumn: ìë™ìœ¼ë¡œ ROWì˜ SOFT DELETE ë‚ ì§œ ì‹œê°„ ì €ì¥
    - @VersionColumn: ìë™ìœ¼ë¡œ ROWê°€ ì—…ë°ì´íŠ¸ë  ë•Œë§ˆë‹¤ 1ì”© ì¦ê°€

```typescript
// user.entity.ts
import { Entity, PrimaryGeneratedColumn, Column } from "typeorm";

@Entity()
export class User {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;

  @Column({ unique: true })
  email: string;

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;

  @DeleteDateColumn()
  deletedAt: Date;

  @VersionColumn()
  version: number;
}
```

- `DaataSource ì„¤ì •`
  - synchronize: trueëŠ” Entity í´ë˜ìŠ¤ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìë™ìœ¼ë¡œ í…Œì´ë¸”ì„ ìƒì„±/ê°±ì‹ 

```typescript
// data-source.ts
import { DataSource } from "typeorm";
import { User } from "./user.entity";

export const AppDataSource = new DataSource({
  type: "mysql", // or 'postgres'
  host: "localhost",
  port: 3306,
  username: "root",
  password: "",
  database: "test",
  entities: [User],
  synchronize: true, // ê°œë°œ ì¤‘ì—ëŠ” true, ìš´ì˜ í™˜ê²½ì—ì„œëŠ” false
});
```

- `ê¸°ë³¸ CRUD`
  - Create & Delete: create(), save(), upsert(), delete(), softDelete(), restore()
  - Update ê´€ë ¨: update(),increment(), decrement()
  - Find ê´€ë ¨: find(), findAndCount(), findOne(), exists(), preload(), query()
  - í†µê³„ ê´€ë ¨: count(), sum(), average(), minimum(), maximum(), query()

```typescript
const userRepo = AppDataSource.getRepository(User);

// CREATE
const user = userRepo.create({ name: "kim", email: "kim@example.com" });
await userRepo.save(user);

// READ
const allUsers = await userRepo.find();
const oneUser = await userRepo.findOneBy({ id: 1 });

// UPDATE
user.name = "Lee";
await userRepo.save(user);

// DELETE
await userRepo.delete(1);
```

- `NestJS ì˜ˆì‹œ`

```typescript
// app.module.ts
import { TypeOrmModule } from "@nestjs/typeorm";

@Module({
  imports: [
    TypeOrmModule.forRoot({
      type: "mysql",
      host: "localhost",
      username: "root",
      database: "test",
      entities: [User],
      synchronize: true,
    }),
    TypeOrmModule.forFeature([User]), // ë ˆí¬ì§€í† ë¦¬ ì£¼ì…ìš©
  ],
})
export class AppModule {}

// user.service.ts
@Injectable()
export class UserService {
  constructor(
    @InjectRepository(User)
    private readonly userRepo: Repository<User>
  ) {}

  async getAllUsers() {
    return this.userRepo.find();
  }
}
```

### 1-2. NextJS TypeORM ì‚¬ìš© ì˜ˆì‹œ

- `ëª¨ë“ˆ ì„¤ì¹˜`

```bash
pnpm i @nestjs/config joi @nestjs/typeorm typeorm pg
```

- `DB ì„¤ì •`

```typescript
import { Module } from "@nestjs/common";
import { MovieModule } from "./movie/movie.module";
import { TypeOrmModule } from "@nestjs/typeorm";
import { ConfigModule, ConfigService } from "@nestjs/config";
import * as Joi from "joi";

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      validationSchema: Joi.object({
        ENV: Joi.string().valid("dev", "prod", "test").required(),
        DB_TYPE: Joi.string().valid("postgres").required(),
        DB_HOST: Joi.string().required(),
        DB_PORT: Joi.number().required(),
        DB_USERNAME: Joi.string().required(),
        DB_PASSWORD: Joi.string().required(),
        DB_DATABASE: Joi.string().required(),
      }),
    }),
    TypeOrmModule.forRootAsync({
      imports: [ConfigModule],
      inject: [ConfigService],
      useFactory: (config: ConfigService) => ({
        type: config.get<"postgres">("DB_TYPE"), // ğŸ‘ˆ ì—¬ê¸°ì„œ ì œë„¤ë¦­ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ
        host: config.get<string>("DB_HOST"),
        port: config.get<number>("DB_PORT"),
        username: config.get<string>("DB_USERNAME"),
        password: config.get<string>("DB_PASSWORD"),
        database: config.get<string>("DB_DATABASE"),
        entities: [],
        synchronize: true,
      }),
    }),
    /*
    TypeOrmModule.forRoot({
      type: process.env.DB_TYPE,
      host: process.env.DB_HOST,
      port: process.env.DB_PORT,
      username: process.env.DB_USERNAME,
      password: process.env.DB_PASSWORD,
      database: process.env.DB_DATABASE,
      entities: [],
      synchronize: true,
    }),
    */
    MovieModule,
  ],
})
export class AppModule {}
```

### 1-3. ê³µí†µ ì»¬ëŸ¼

- `Entity Embedding`
  - ê³µí†µ ì»¬ëŸ¼ì„ ê°ì²´ë¡œ ì •ì˜í•´ì„œ ì‚½ì…í•  ìˆ˜ ìˆë‹¤.

```typescript
export class Name {
  @Column()
  first: string;

  @Column()
  last: string;
}

@Entity()
export class User {
  @PrimaryGgeneratedColumn()
  id: string;

  // nameFirst, nameLast ì»¬ëŸ¼ì´ ì¶”ê°€ë¨
  @Column(() => Name)
  name: Name;

  @Column
  isActive: boolean;
}
```

- `Entity Inheritance`

```typescript
export abstract class Content {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  title: string;

  @Column()
  description: string;
}

@Entity()
export class Photo extends Content {
  @Column()
  size: string;
}

@Entity()
export class Post extends Content {
  @Column()
  viewCount: number;
}
```

- `Single Table Inheritance`
  - id, type, title, description, size, viewCount í•„ë“œê°€ ì¡´ì¬í•˜ëŠ” content í…Œì´ë¸”ì´ ìƒì„±
  - Photoì—ë§Œ size ì¡´ì¬
  - Postì—ë§Œ viewCount ì¡´ì¬
  - Contentì˜ type ê°’ìœ¼ë¡œ Photo, Post êµ¬ë¶„

```typescript
@Entity()
@TableInheritance({
  column: {
    type: "varchar",
    name: "type",
  },
})
export class Content {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  title: string;

  @Column()
  description: string;
}

@ChildEntity()
export class Photo extends Content {
  @Column()
  size: string;
}

@ChildEntity()
export class Post extends Content {
  @Column()
  viewCount: number;
}
```

### 1-4. ê´€ê³„ ì„¤ì •

- @OneToOne, @ManyToOne, @OneToMany, @ManyToMany

#### Relationship ì ìš© ì˜ˆì‹œ

- ì²« ë²ˆì¨° íŒŒë¼ë¯¸í„°ì—ëŠ” íƒ€ì…ì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ë¥¼ ì…ë ¥
- ë‘ ë²ˆì¨° íŒŒë¼ë¯¸í„°ì—ëŠ” ì²« ë²ˆì¨° íŒŒë¼ë¯¸í„°ì— ì…ë ¥í•œ í´ë˜ìŠ¤ì˜ ì»¬ëŸ¼ ì¤‘ í•˜ë‚˜ë¥¼ ì…ë ¥
- OneToMany, ManyToOne ê´€ê³„ì—ì„œëŠ” Many ì¸¡ì—ì„œ Foreign Key ë ˆí¼ëŸ°ìŠ¤ë¥¼ ê°€ì§„ë‹¤.
- OneToOne ê´€ê³„ì—ì„œëŠ” ë‘ í…Œì´ë¸” ì¤‘ ëˆ„ê°€ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ë“¤ê³  ìˆì–´ë„ ìƒê´€ì—†ë‹¤. ë•Œë¬¸ì—, @JoinColumn ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ê°€ì§ˆ í…Œì´ë¸”ì„ ì§€ì •í•œë‹¤.
- ManyToMany ê´€ê³„ì—ì„œë„ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ê°€ì§ˆ í…Œì´ë¸”ì— @JoinTable ì–´ë…¸í…Œì´ì…˜ì„ ì§€ì •í•œë‹¤.
- ManyToManyëŠ” ì¤‘ê°„ í…Œì´ë¸”ì´ ìƒì„±ëœë‹¤.

```typescript
@Entity()
export class User {
  @PrimaryGeneratedColumn()
  id: number;

  @Column
  name: string;

  // user í…Œì´ë¸”ì—ëŠ” ì¶”ê°€ë¡œ ì»¬ëŸ¼ì´ ìƒì„±ë˜ì§€ ì•ŠìŒ
  // Many ì…ì¥ì—ì„œ Foreign Key ë ˆí¼ëŸ°ìŠ¤ë¥¼ ê°€ì§
  @OneToMany(() => Photo, (photo) => photo.user)
  photos: Photo[];

  @OneToOne(() => Profile)
  @JoinColumn()
  profile: Profile;
}

// ManyToOne
@Entity()
export class Photo {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  url: string;

  // Photo í…Œì´ë¸”ì—ëŠ” user_id ì»¬ëŸ¼ì´ ìë™ìœ¼ë¡œ ìƒì„±
  // ë„¤ì´ë° íŒ¨í„´ì€ "ìƒëŒ€í…Œì´ë¸”ì´ë¦„_id"
  @ManyToOne(() => User, (user) => user.photos)
  user: User;
}

// OneToOne
@Entity()
export class Profile {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  gender: string;

  @Column()
  photo: string;

  @OneToOne(() => User, (user) => user.profile)
  user: User;
}

// ManyToMany
@Entity()
export class Category {
  @PrimaryGeneratedColumn()
  id: number;

  @Column
  name: string;

  @ManyToMany(() => Question)
  questions: Question[];
}

@Entity()
export class Question {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  title: string;

  @Column()
  text: string;

  @ManyToMany(() => Category)
  @JoinTable()
  categories: Category[];
}
```

## 2. QueryBuilder

## 3. Transaction

## 4. ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
