# NestJS 핵심개념

## 1. NestJS 라이프사이클

```
Client Request > Middleware > Guard > Interceptor > Pipe > 
요청 로직 처리(Controller, Service, Repository) > Exception Filter > Interceptor > Response
```

<div align="center">
    <img src="./images/01.png">
</div>
<br/>

### Middleware

 - 전체 route에 적용
 - 특정 route에 적용
 - main.ts에서 함수 형식으로 전체 적용
```typescript

```

### Guard

 - 주로 인증 처리를 위해 사용
 - 전역으로 적용
 - 컨트롤러에 적용
 - route에 적용
```typescript
// 1. 커스텀 Guard 정의
// custom.guard.ts
import {
  CanActivate,
  ExecutionContext,
  Injectable,
  NotFoundException,
} from '@nestjs/common';
import { Observable } from 'rxjs';

@Injectable()
export class CustomGuard implements CanActivate {
  canActivate(
    context: ExecutionContext,
  ): boolean | Promise<boolean> | Observable<boolean> {
    console.log('this is custom guard');
    return true;
  }
}

// 2. 전역으로 적용 (main.ts)
app.useGlobalGuards(new CustomGuard())

// 3. 컨트롤러에 적용
@Controller('notifications')
@UseGuards(CustomGuard) 
export class NotificationsController {

  // 4. 특정 route에 적용
  @Get(':id')
  @UseGuards(CustomGuard)
  findOne(@Param('id') id:string) {
    // ..
  }
}
```

### Interceptor

 - 컨트롤러 요청전, 요청후에 로직을 수행
 - pipe() 안에 메서드를 작성하여 컨트롤러 요청 후 Response를 제어할 수 있음
 - 전역, 컨트롤러, 라우트 레벨로 정의 가능
 - 요청 진입시 global > controller > route 레벨로 방문하고, 반대로 응답시에는 route > controller > global 순으로 방문
```typescript
// 1. 커스텀 Interceptor 정의
import {
  Injectable,
  NestInterceptor,
  ExecutionContext,
  CallHandler,
} from '@nestjs/common';
import { Observable } from 'rxjs';
import { tap } from 'rxjs/operators';

@Injectable()
export class CustomInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    // pre-interceptors
    console.log('this is pre custom interceptor');

    return next
      .handle()
      .pipe(tap(() => {
        // post-interceptor
        console.log(`this is post custom route interceptor`)
      }));
  }
}

// 2. 전역으로 적용 (main.ts)
app.useGlobalInterceptors(new CustomInterceptor());

// 3. 컨트롤러에 적용
@Controller('notifications')
@UseInterceptors(CustomInterceptor) 
export class NotificationsController {

  // 4. 특정 route에 적용
  @Get(':id')
  @UseInterceptors(CustomInterceptor)
  findOne(@Param('id') id:string) {
    // ..
  }
}
```

### Pipe

 - 유효성 검사, 요청 파라미터 형변환 등 처리
 - 전역, 컨트롤러, 라우트 레벨로 정의 가능
```typescript
// 1. 커스텀 Pipe 정의 (custom.pipe.ts)
import { PipeTransform, Injectable, ArgumentMetadata } from '@nestjs/common';

@Injectable()
export class CustomPipe implements PipeTransform {
  transform(value: any, metadata: ArgumentMetadata) {
    console.log('this is custom pipe');
    return value;
  }
}

// 2. 전역으로 적용 (main.ts)
app.useGlobalPipes(new CustomPipe());

// 3. 컨트롤러에 적용
@Controller('notifications')
@UsePipes(CustomPipe) 
export class NotificationsController {
    
  // 4. 특정 route에 적용
  @Get(':id')
  @UsePipes(CustomPipe)
  findOne(@Param('id', ParseIntPipe) id:number) {
    // ..
  }
}
```

## 2. 컨트롤러

